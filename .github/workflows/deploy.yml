name: Deploy OdbVue

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  build:
    name: Build Applications
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'apps/pnpm-lock.yaml'
      
      - name: Install dependencies
        run: cd apps && pnpm install --frozen-lockfile
      
      - name: Build Vue app
        run: cd apps && pnpm build
      
      - name: Build VitePress wiki
        run: cd apps && pnpm wiki:build
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/dist
            apps/.vitepress/dist
          retention-days: 1
      
      - name: Reorganize artifacts for deployment
        run: |
          mkdir -p build-artifacts/apps
          mkdir -p build-artifacts/wiki
          cp -r apps/dist/* build-artifacts/apps/ || true
          cp -r apps/.vitepress/dist/* build-artifacts/wiki/ || true
      
      - name: Upload reorganized artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-reorganized
          path: build-artifacts/
          retention-days: 1

  deploy:
    name: Deploy to OCI
    needs: build
    runs-on: ubuntu-latest
    
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-reorganized
          path: build-artifacts
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "${{ secrets.SSH_HOST_KEY }}" >> ~/.ssh/known_hosts
      
      - name: Copy deployment scripts to remote
        run: |
          scp -i ~/.ssh/deploy_key -r i13e/oci/basic/scripts/* \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:~/deploy/
      
      - name: Copy built artifacts to remote
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "mkdir -p ~/build-artifacts/apps ~/build-artifacts/wiki"
          scp -i ~/.ssh/deploy_key -r build-artifacts/apps/* ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:~/build-artifacts/apps/
          scp -i ~/.ssh/deploy_key -r build-artifacts/wiki/* ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:~/build-artifacts/wiki/
      
      - name: Create sites.yaml with correct paths
        run: |
          cat > /tmp/sites.yaml << 'EOF'
          sites:
            - site_name: "main"
              domain: "odbvue.com"
              remote_path: "/var/www/main/"
              local_path: "~/build-artifacts/main"
            - site_name: "apps"
              domain: "apps.odbvue.com"
              remote_path: "/var/www/apps/"
              local_path: "~/build-artifacts/apps"
            - site_name: "wiki"
              domain: "wiki.odbvue.com"
              remote_path: "/var/www/wiki/"
              local_path: "~/build-artifacts/wiki"
          ssl:
            cert_file: "./.ssl/STAR.odbvue.com.crt"
            key_file: "./.ssl/STAR.odbvue.com_key.txt"
            ca_bundle_file: "./.ssl/STAR.odbvue.com.ca-bundle"
          EOF
          scp -i ~/.ssh/deploy_key /tmp/sites.yaml ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:~/deploy/sites.yaml
      
      - name: Execute deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "cd ~/deploy && bash deploy.sh 2>&1"
      
      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "sudo systemctl status nginx"
      
      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
